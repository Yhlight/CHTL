# CHTL编译器开发进度汇报 - 012

## 预定义内容系统完成
- 时间：2024年
- 阶段：Registry和预定义内容实现

## 实现目标
1. **Registry单例管理器**
   - 统一管理所有预定义内容
   - 懒加载机制
   - 缓存管理

2. **预定义内容类**
   - PredefinedCustomStyles
   - PredefinedCustomElements
   - PredefinedCustomVariables
   - PredefinedTemplateStyles
   - PredefinedTemplateElements
   - PredefinedTemplateVariables

3. **CHTL代码定义**
   - 使用CHTL语法定义预设
   - 通过PredefinedParser解析

## 核心架构

### 1. **Registry设计**

```cpp
class Registry {
private:
    // 懒加载存储
    std::unordered_map<std::string, std::shared_ptr<CustomStyleNode>> customStyles;
    std::unordered_map<std::string, std::shared_ptr<CustomElementNode>> customElements;
    // ... 其他类型
    
    // 工厂函数注册
    std::unordered_map<std::string, std::function<std::shared_ptr<CustomStyleNode>()>> customStyleFactories;
    // ... 其他工厂
    
public:
    static Registry& getInstance();  // 单例模式
    
    // 懒加载获取
    std::shared_ptr<CustomStyleNode> getCustomStyle(const std::string& name);
    // ... 其他获取方法
};
```

特点：
- **单例模式**：全局唯一实例
- **懒加载**：首次使用时才解析
- **工厂模式**：延迟创建对象
- **缓存机制**：避免重复解析

### 2. **PredefinedParser**

```cpp
class PredefinedParser {
public:
    static std::shared_ptr<CustomStyleNode> parseCustomStyle(
        const std::string& name, 
        const std::string& chtlCode);
    // ... 其他解析方法
};
```

负责将CHTL代码解析为对应的AST节点。

### 3. **预定义内容组织**

#### 自定义样式（PredefinedCustomStyles）
包含30+个预定义样式：

**文本样式**
- DefaultText, Heading1-3, SmallText
- BoldText, ItalicText, UnderlineText

**颜色主题**
- PrimaryColor, SecondaryColor
- SuccessColor, WarningColor, ErrorColor, InfoColor

**布局样式**
- FlexCenter, FlexRow, FlexColumn
- GridContainer, Hidden

**边框和阴影**
- BorderDefault, BorderRounded
- ShadowSmall, ShadowMedium, ShadowLarge

**间距**
- PaddingSmall/Medium/Large
- MarginSmall/Medium/Large

**动画**
- FadeIn, SlideIn, ScaleIn

**响应式**
- MobileOnly, DesktopOnly

#### 自定义元素（PredefinedCustomElements）
包含25+个UI组件：

**布局组件**
- Container, Card, Header, Footer
- Sidebar, MainContent

**导航组件**
- Navbar, NavItem, Breadcrumb, Pagination

**表单组件**
- FormGroup, InputGroup, ButtonGroup

**内容组件**
- Article, Section, Alert, Badge
- Modal, Tooltip

**媒体组件**
- MediaObject, Gallery, Carousel

**列表组件**
- ListGroup, ListItem

#### 自定义变量组（PredefinedCustomVariables）
包含10个设计系统：

- DefaultTheme, DarkTheme, LightTheme
- SpacingSystem
- FontSystem
- BreakpointSystem
- AnimationDurations
- ZIndexSystem
- BorderRadiusSystem
- ShadowSystem

## 使用CHTL定义预设

### 样式定义示例
```chtl
[Custom] @Style FlexCenter {
    display: "flex";
    justify-content: "center";
    align-items: "center";
}

[Custom] @Style Heading1 {
    @Style DefaultText;
    font-size: "2.5rem";
    font-weight: "bold";
    margin-top: "1rem";
    margin-bottom: "1rem";
}
```

### 元素定义示例
```chtl
[Custom] @Element Card {
    div {
        style {
            @Style BorderDefault;
            @Style BorderRounded;
            @Style ShadowSmall;
            @Style PaddingMedium;
            background-color: "white";
        }
        
        div {
            style {
                @Style MarginSmall;
            }
        }
    }
}
```

### 变量组定义示例
```chtl
[Custom] @Var DefaultTheme {
    primary: "#007bff";
    secondary: "#6c757d";
    success: "#28a745";
    danger: "#dc3545";
    warning: "#ffc107";
    info: "#17a2b8";
    
    textPrimary: "#212529";
    textSecondary: "#6c757d";
    textMuted: "#adb5bd";
}
```

## 懒加载机制

```cpp
std::shared_ptr<CustomStyleNode> Registry::getCustomStyle(const std::string& name) {
    // 1. 检查缓存
    auto it = customStyles.find(name);
    if (it != customStyles.end()) {
        return it->second;
    }
    
    // 2. 查找工厂函数
    auto factoryIt = customStyleFactories.find(name);
    if (factoryIt != customStyleFactories.end()) {
        // 3. 懒加载：创建并缓存
        auto node = factoryIt->second();
        customStyles[name] = node;
        return node;
    }
    
    return nullptr;
}
```

优点：
- **性能优化**：只加载需要的内容
- **内存效率**：按需创建对象
- **启动速度**：避免初始化开销

## 自动注册机制

利用C++静态初始化：

```cpp
// 静态初始化
static struct CustomStylesInitializer {
    CustomStylesInitializer() {
        PredefinedCustomStyles::registerAll();
    }
} customStylesInitializer;
```

程序启动时自动注册所有预定义内容。

## 模板系统

除了Custom，还提供了Template类型的预定义：

```cpp
[Template] @Style BaseButton {
    display: "inline-block";
    padding: "0.375rem 0.75rem";
    cursor: "pointer";
    // ... 基础按钮样式
}

[Template] @Element BaseLayout {
    div {
        style {
            display: "flex";
            flex-direction: "column";
            min-height: "100vh";
        }
        // ... 布局结构
    }
}

[Template] @Var BaseColors {
    black: "#000000";
    white: "#ffffff";
    // ... 基础颜色
}
```

模板不能被特例化，只能被继承。

## 设计系统集成

预定义内容构成了完整的设计系统：

1. **颜色系统**：主题变量组
2. **排版系统**：文本样式和字体变量
3. **间距系统**：统一的padding/margin
4. **组件库**：可复用的UI组件
5. **响应式**：断点和媒体查询
6. **动画系统**：过渡和动画时长

## 测试覆盖

```cpp
void runAllTests() {
    testRegistryInstance();    // 单例测试
    testLazyLoading();        // 懒加载测试
    testPredefinedStyles();   // 样式测试
    testPredefinedElements(); // 元素测试
    testPredefinedVariables();// 变量测试
    testTemplates();          // 模板测试
    testCacheClearing();      // 缓存测试
}
```

## 实现亮点

### 1. **真正的懒加载**
- 工厂函数延迟执行
- 首次访问时解析CHTL
- 结果缓存复用

### 2. **使用CHTL定义**
- 自举（Self-hosting）
- 语法一致性
- 易于扩展

### 3. **完整的设计系统**
- 30+预定义样式
- 25+UI组件
- 10个变量系统
- 覆盖常见需求

### 4. **类型安全**
- 强类型的节点系统
- 编译时类型检查
- 避免运行时错误

### 5. **模块化设计**
- 每种预定义类型独立文件
- 清晰的职责划分
- 易于维护和扩展

## 性能考虑

1. **懒加载优化**
   - 避免启动时解析所有预定义
   - 按需加载减少内存占用

2. **缓存策略**
   - 一次解析，多次使用
   - 可清除缓存释放内存

3. **静态字符串**
   - CHTL代码存储为静态常量
   - 避免运行时字符串构造

## 扩展性

添加新的预定义内容非常简单：

1. 在对应的头文件添加声明
2. 在cpp文件添加CHTL定义
3. 在registerAll中注册

系统会自动处理懒加载和缓存。

## 总结

预定义内容系统的实现达到了以下目标：

1. **完整性**：提供了丰富的预定义样式、元素和变量
2. **高性能**：懒加载机制确保快速启动和低内存占用
3. **易用性**：简单的API，自动注册
4. **可扩展**：轻松添加新的预定义内容
5. **自举性**：使用CHTL定义预设，展示了语言的表达力

这个系统为CHTL用户提供了开箱即用的设计系统，同时保持了灵活性和性能。通过Registry的统一管理，预定义内容的使用变得简单而高效。